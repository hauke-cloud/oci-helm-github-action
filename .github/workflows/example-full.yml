name: Example - Full CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Run linting and tests first
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up programming language
        run: echo "Add your language setup here"

      - name: Run linters
        run: echo "Add your linting commands here"

      - name: Run tests
        run: echo "Add your test commands here"

  # Build and deploy only on main branch after tests pass
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: [lint-and-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Build and Deploy OCI Image and Helm Chart
        uses: hauke-cloud/oci-helm-github-action@v1
        id: build-deploy
        with:
          # Version configuration
          calculate-version: 'true'
          push-tag: 'true'
          
          # Docker configuration
          build-docker: 'true'
          dockerfile-path: './Dockerfile'
          docker-context: '.'
          image-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          docker-platforms: 'linux/amd64,linux/arm64'
          tag-latest: 'true'
          
          # Helm configuration
          build-helm: 'true'
          chart-dir: './helm'
          oci-registry: ${{ env.REGISTRY }}
          oci-namespace: ${{ github.repository_owner }}/charts
          
          # Registry authentication
          registry-username: ${{ github.actor }}
          registry-password: ${{ secrets.GITHUB_TOKEN }}
          
          # Release configuration
          create-github-release: 'true'
          release-notes: |
            ## What's Changed
            
            This release includes the latest changes from the main branch.
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}

      - name: Print outputs
        run: |
          echo "Version: ${{ steps.build-deploy.outputs.version }}"
          echo "Docker Image: ${{ steps.build-deploy.outputs.docker-image }}"
          echo "Helm Chart: ${{ steps.build-deploy.outputs.helm-chart }}"
